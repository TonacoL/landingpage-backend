<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Upload Protegido</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      background-color: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 1em;
      overflow-x: hidden;
    }
    .container {
      background: #1e1e1e;
      padding: 2em;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 450px;
      margin-bottom: 2em;
    }
    h1 {
      font-size: 1.4em;
      text-align: center;
      margin-bottom: 1em;
    }
    form {
      display: flex;
      flex-direction: column;
    }
    #dropZone {
      border: 2px dashed #444;
      border-radius: 8px;
      padding: 1.5em;
      text-align: center;
      color: #888;
      margin-bottom: 1em;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
      user-select: none;
    }
    #dropZone.dragover {
      background-color: #333;
      border-color: #aaa;
      color: #eee;
    }
    input[type="file"] {
      display: none;
    }
    button {
      margin-top: 1em;
      padding: 0.75em;
      background-color: #333;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover:not(:disabled) {
      background-color: #555;
    }
    button:disabled {
      background-color: #222;
      cursor: not-allowed;
      opacity: 0.6;
    }
    #fileList {
      list-style: none;
      padding: 0;
      margin: 0.5em 0 0 0;
      max-height: 150px;
      overflow-y: auto;
      border: 1px solid #444;
      border-radius: 5px;
      background-color: #222;
    }
    #fileList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.4em 0.6em;
      border-bottom: 1px solid #444;
      font-size: 0.9em;
      color: #ddd;
    }
    #fileList li:last-child {
      border-bottom: none;
    }
    .removeBtn {
      background: none;
      border: none;
      color: #ff5555;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.1em;
      padding: 0 0.3em;
      line-height: 1;
    }
    .progressBarContainer {
      background: #444;
      border-radius: 3px;
      overflow: hidden;
      width: 100px;
      height: 8px;
      margin-left: 0.8em;
    }
    .progressBar {
      background: #4caf50;
      height: 100%;
      width: 0%;
      transition: width 0.2s ease;
    }
    #responseMsg {
      margin-top: 1em;
      word-break: break-word;
      font-size: 0.95em;
      min-height: 1.2em;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Enviar e Proteger Arquivos</h1>
    <form id="uploadForm">
      <label id="dropZone" for="fileInput">
        Arraste os arquivos aqui ou clique para selecionar<br/>
        <small>(.pdf, .doc, .docx, .xls, .xlsx)</small>
      </label>
      <input type="file" id="fileInput" name="files" accept=".pdf,.doc,.docx,.xls,.xlsx" multiple />
      
      <ul id="fileList"></ul>

      <button type="submit" disabled>Enviar e Proteger</button>
    </form>
    <p id="responseMsg"></p>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const dropZone = document.getElementById('dropZone');
    const fileList = document.getElementById('fileList');
    const responseMsg = document.getElementById('responseMsg');
    const submitBtn = uploadForm.querySelector('button[type="submit"]');

    let filesToUpload = [];

    function updateFileList() {
      fileList.innerHTML = '';
      filesToUpload.forEach((file, idx) => {
        const li = document.createElement('li');
        li.textContent = file.name;

        // Progress bar container
        const progressContainer = document.createElement('div');
        progressContainer.className = 'progressBarContainer';

        const progressBar = document.createElement('div');
        progressBar.className = 'progressBar';
        progressContainer.appendChild(progressBar);

        li.appendChild(progressContainer);

        // Remove button
        const removeBtn = document.createElement('button');
        removeBtn.className = 'removeBtn';
        removeBtn.title = 'Remover arquivo';
        removeBtn.innerHTML = '&times;';
        removeBtn.addEventListener('click', () => {
          filesToUpload.splice(idx, 1);
          updateFileList();
          submitBtn.disabled = filesToUpload.length === 0;
          responseMsg.textContent = '';
        });
        li.appendChild(removeBtn);

        fileList.appendChild(li);
      });
      submitBtn.disabled = filesToUpload.length === 0;
    }

    // Handle files dropped or selected
    function handleFiles(selectedFiles) {
      for (const file of selectedFiles) {
        // evitar duplicados pelo nome e tamanho
        if (!filesToUpload.some(f => f.name === file.name && f.size === file.size)) {
          filesToUpload.push(file);
        }
      }
      updateFileList();
    }

    fileInput.addEventListener('change', () => {
      handleFiles(fileInput.files);
      fileInput.value = ''; // limpar input para poder selecionar mesmos arquivos depois
    });

    // Drag & Drop UI
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', e => {
      dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        handleFiles(e.dataTransfer.files);
      }
    });

    // Upload com progressos separados por arquivo
    uploadForm.addEventListener('submit', async e => {
      e.preventDefault();
      if (filesToUpload.length === 0) {
        responseMsg.textContent = "Por favor, selecione ao menos um arquivo.";
        return;
      }
      submitBtn.disabled = true;
      responseMsg.textContent = "";

      // Limpa progressos visuais antes do envio
      const progressBars = document.querySelectorAll('.progressBar');
      progressBars.forEach(pb => pb.style.width = '0%');

      try {
        // Uploads paralelos com Promise.all, ou sequencial para controle mais fino
        // Aqui farei sequencial para mostrar progresso individual
        for (let i = 0; i < filesToUpload.length; i++) {
          await uploadSingleFile(filesToUpload[i], i);
        }
        responseMsg.style.color = "#4caf50";
        responseMsg.textContent = "✅ Upload(s) concluído(s) com sucesso! Redirecionando...";

        // Exemplo: redirecionar para o primeiro arquivo recebido (ou adaptar conforme backend)
        // Se seu backend retornar link por arquivo, adapte aqui:
        setTimeout(() => {
          // Se quiser abrir o primeiro arquivo enviado:
          // window.location.href = 'visualizar.html?pdf=' + encodeURIComponent(/* link do backend aqui */);
          // Como não tem backend adaptado para múltiplos arquivos, só limpamos lista:
          filesToUpload = [];
          updateFileList();
          responseMsg.textContent = "";
          submitBtn.disabled = true;
        }, 2500);

      } catch (error) {
        responseMsg.style.color = "#ff5555";
        responseMsg.textContent = `❌ Erro ao enviar arquivos: ${error.message || error}`;
        submitBtn.disabled = false;
      }
    });

    function uploadSingleFile(file, index) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const url = 'https://landingpage-backend-z28u.onrender.com/upload'; // ajuste conforme backend

        xhr.open('POST', url, true);

        // Atualiza barra de progresso do arquivo
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            const progressBar = document.querySelectorAll('.progressBar')[index];
            if (progressBar) progressBar.style.width = percent + '%';
          }
        };

        xhr.onload = () => {
          if (xhr.status === 200) {
            // Tenta parsear JSON para verificar resposta
            try {
              const resp = JSON.parse(xhr.responseText);
              if (resp && resp.link) {
                resolve(resp.link);
              } else {
                reject(new Error('Resposta inválida do servidor.'));
              }
            } catch {
              reject(new Error('Não foi possível interpretar a resposta do servidor.'));
            }
          } else {
            reject(new Error(`Erro ${xhr.status}: ${xhr.statusText}`));
          }
        };

        xhr.onerror = () => {
          reject(new Error('Erro na requisição.'));
        };

        const formData = new FormData();
        formData.append('file', file);

        xhr.send(formData);
      });
    }
  </script>
</body>
</html>
