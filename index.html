<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Upload Protegido - Multi</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      background-color: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 1em;
      overflow-x: hidden;
    }
    .container {
      background: #1e1e1e;
      padding: 2em;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 600px;
      margin-bottom: 2em;
    }
    #dropArea {
      border: 3px dashed #555;
      padding: 1em;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      color: #bbb;
      transition: border-color 0.3s ease;
    }
    #dropArea.dragover {
      border-color: #0f0;
      color: #0f0;
    }
    input[type="file"] {
      display: none;
    }
    button {
      margin-top: 1em;
      padding: 0.7em;
      width: 100%;
      background-color: #333;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 1.1em;
    }
    button:hover {
      background-color: #555;
      cursor: pointer;
    }
    #fileList {
      margin-top: 1em;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #444;
      border-radius: 5px;
      padding: 0.5em;
      background: #222;
    }
    #fileList li {
      margin-bottom: 0.5em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #fileList li span {
      flex-grow: 1;
      overflow-wrap: break-word;
    }
    #fileList li button.removeBtn {
      background: #900;
      border: none;
      color: white;
      border-radius: 3px;
      padding: 0.2em 0.5em;
      margin-left: 1em;
      cursor: pointer;
    }
    #fileList li button.removeBtn:hover {
      background: #c00;
    }
    #previewArea {
      margin-top: 1em;
      background: #111;
      padding: 1em;
      border-radius: 10px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
      border: 1px solid #444;
      color: #eee;
    }
    #progressBarContainer {
      margin-top: 1em;
      background: #333;
      border-radius: 5px;
      overflow: hidden;
      height: 20px;
      width: 100%;
      max-width: 600px;
    }
    #progressBar {
      height: 100%;
      width: 0;
      background: #0f0;
      transition: width 0.2s ease;
    }
    #responseMsg {
      margin-top: 1em;
      word-break: break-word;
      font-size: 0.95em;
      min-height: 1.2em;
    }
    h1 {
      font-size: 1.6em;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Enviar e Proteger Arquivos</h1>
    <div id="dropArea">Arraste e solte os arquivos aqui ou clique para selecionar</div>
    <input type="file" id="fileInput" name="files" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.odt,.png,.jpg,.jpeg,.bmp,.gif,.txt,.rtf,.html,.csv,.svg" />
    <ul id="fileList"></ul>
    <div id="previewArea" hidden></div>
    <button id="uploadBtn" disabled>Enviar e Proteger</button>
    <div id="progressBarContainer" hidden>
      <div id="progressBar"></div>
    </div>
    <p id="responseMsg"></p>
  </div>

  <script>
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const previewArea = document.getElementById('previewArea');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressBar = document.getElementById('progressBar');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const responseMsg = document.getElementById('responseMsg');

    let filesToUpload = [];

    dropArea.addEventListener('click', () => fileInput.click());

    dropArea.addEventListener('dragover', e => {
      e.preventDefault();
      dropArea.classList.add('dragover');
    });
    dropArea.addEventListener('dragleave', e => {
      e.preventDefault();
      dropArea.classList.remove('dragover');
    });
    dropArea.addEventListener('drop', e => {
      e.preventDefault();
      dropArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', e => {
      handleFiles(e.target.files);
      fileInput.value = ''; // reset para aceitar mesmo arquivo depois
    });

    function handleFiles(fileListRaw) {
      const newFiles = Array.from(fileListRaw);

      // Evitar duplicatas pelo nome + tamanho
      newFiles.forEach(newFile => {
        if (!filesToUpload.some(f => f.name === newFile.name && f.size === newFile.size)) {
          filesToUpload.push(newFile);
        }
      });

      renderFileList();
      uploadBtn.disabled = filesToUpload.length === 0;
      previewArea.hidden = true;
      responseMsg.textContent = '';
    }

    function renderFileList() {
      fileList.innerHTML = '';
      filesToUpload.forEach((file, idx) => {
        const li = document.createElement('li');
        const span = document.createElement('span');
        span.textContent = `${file.name} (${formatBytes(file.size)})`;
        li.appendChild(span);

        const removeBtn = document.createElement('button');
        removeBtn.textContent = 'Remover';
        removeBtn.classList.add('removeBtn');
        removeBtn.addEventListener('click', () => {
          filesToUpload.splice(idx, 1);
          renderFileList();
          uploadBtn.disabled = filesToUpload.length === 0;
          previewArea.hidden = true;
          responseMsg.textContent = '';
        });
        li.appendChild(removeBtn);

        li.addEventListener('click', () => previewFile(file));

        fileList.appendChild(li);
      });
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function previewFile(file) {
      previewArea.hidden = false;
      responseMsg.textContent = '';
      if (file.type.startsWith('text/') || file.type === 'application/json' || file.name.endsWith('.html') || file.name.endsWith('.csv') || file.name.endsWith('.svg')) {
        const reader = new FileReader();
        reader.onload = () => {
          previewArea.textContent = reader.result;
        };
        reader.onerror = () => {
          previewArea.textContent = 'Erro ao carregar visualização.';
        };
        reader.readAsText(file);
      } else if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = () => {
          previewArea.innerHTML = `<img src="${reader.result}" style="max-width:100%; max-height:250px; border-radius:8px;" alt="Preview da imagem" />`;
        };
        reader.onerror = () => {
          previewArea.textContent = 'Erro ao carregar visualização.';
        };
        reader.readAsDataURL(file);
      } else {
        previewArea.textContent = 'Pré-visualização indisponível para este tipo de arquivo.';
      }
    }

    uploadBtn.addEventListener('click', async () => {
      if (filesToUpload.length === 0) {
        responseMsg.textContent = 'Nenhum arquivo selecionado.';
        return;
      }

      responseMsg.textContent = '';
      progressBar.style.width = '0%';
      progressBarContainer.hidden = false;
      uploadBtn.disabled = true;

      try {
        const formData = new FormData();
        filesToUpload.forEach(file => formData.append('files', file));

        const xhr = new XMLHttpRequest();

        xhr.open('POST', 'https://landingpage-backend-z28u.onrender.com/upload', true);

        xhr.upload.onprogress = e => {
          if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            progressBar.style.width = percent + '%';
          }
        };

        xhr.onload = () => {
          uploadBtn.disabled = false;
          progressBarContainer.hidden = true;

          if (xhr.status === 200) {
            const res = JSON.parse(xhr.responseText);
            if (res.success && res.files && res.files.length > 0) {
              responseMsg.innerHTML = '✅ Upload feito com sucesso!<br/><ul>' + res.files.map(f => `<li><a href="${f.downloadLink}" target="_blank" rel="noopener noreferrer">${f.originalName}</a></li>`).join('') + '</ul>';
              filesToUpload = [];
              renderFileList();
              previewArea.hidden = true;
            } else {
              responseMsg.textContent = '❌ Resposta inesperada do servidor.';
            }
          } else {
            responseMsg.textContent = '❌ Erro ao enviar: ' + (JSON.parse(xhr.responseText)?.error || xhr.statusText);
          }
        };

        xhr.onerror = () => {
          uploadBtn.disabled = false;
          progressBarContainer.hidden = true;
          responseMsg.textContent = '❌ Erro na requisição.';
        };

        xhr.send(formData);
      } catch (err) {
        uploadBtn.disabled = false;
        progressBarContainer.hidden = true;
        responseMsg.textContent = '❌ Erro inesperado: ' + err.message;
      }
    });
  </script>
</body>
</html>
